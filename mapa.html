<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">

 		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<script src="leaflet/leaflet.js" ></script>
		<script src="d3_color-legend.js" ></script>
		<script src="https://d3js.org/d3.v5.min.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
		<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
		<script>
			$( function() {
				$( "#datepicker" ).datepicker();
			} );
		</script>
	<style>
  		#map { height: 100%; width: 100%; }
	</style>
	</head>
	<body>
		<div style="float: right">Date: <input type="text" id="datepicker"></div>

		<div id="map"></div>

		<script>
			const so2_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "SO2"
			})

			const no2_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "NO2"
			})

			const pm25_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "PM 2.5"
			})

			const pm10_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "PM 10"
			})

			const o3_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "O3"
			})

			var map = L.map('map').setView([40.4165, -3.70256], 13).on('popupopen', function () {
				d3.select("#SO2Legend")
				  .node()
				  .appendChild(so2_legend);
				d3.select("#NO2Legend")
				  .node()
				  .appendChild(no2_legend);
				d3.select("#PM25Legend")
				  .node()
				  .appendChild(pm25_legend);
				d3.select("#PM10Legend")
				  .node()
				  .appendChild(pm10_legend);
				d3.select("#O3Legend")
				  .node()
				  .appendChild(o3_legend);
			});

			var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
					'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1
			}).addTo(map);


			//var circle=L.circle([40.423852,-3.712246], {radius: 200}).addTo(map);


			d3.dsv(";", "./data/estaciones_control_aire.csv").then(function(data) {
				console.log(data[0]);
				data.forEach(function(d) {
					var latitud = d.LATITUD;
					var longitud = d.LONGITUD;
					var estacion = d.CODIGO_CORTO;
					var nom_estacion = d.ESTACION
					var circle = L.circle([latitud, longitud], {radius: 200}).addTo(map);

					d3.dsv(";", "./data/datos202111.csv").then(function(data) {
						var filteredData = data.filter(function(row, i) {
							return row.MES == '01' && row.ESTACION == estacion;
						});

						var indice_calidad = 0;

						filteredData.forEach(function(item) {
							var magnitud = item.MAGNITUD;
							var valor = item.V01;
							if (magnitud == 8) {
								if (valor <= 40)
									indice_calidad = 0;
								else if (valor <= 100)
									indice_calidad = 1;
								else if (valor <= 200)
									indice_calidad = 2;
								else if (valor <= 400)
									indice_calidad = 3;
								else
									indice_calidad = 4;
							}

						});

						//circle.bindPopup(new L.popup().setContent('<div id="SO2Legend"></div><div id="NO2Legend"></div><div id="PM25Legend"></div><div id="PM10Legend"></div><div id="O3Legend"></div>'));

						circle.bindPopup(new L.popup().setContent('<div>' + nom_estacion + ' ' + indice_calidad + '</div>'));
					});

				});
			});

		</script>
	</body>
</html>
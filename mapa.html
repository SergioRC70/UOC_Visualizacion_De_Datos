<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">

 		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<script src="leaflet/leaflet.js" ></script>

		<script src="d3_color-legend.js" ></script>
		<script src="https://d3js.org/d3.v5.min.js"></script>

		<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
		<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Lato:wght@700&display=swap" rel="stylesheet">

		<script>
			$( function() {
				$( "#datepicker" ).datepicker();
			} );
		</script>
		<style>
			body, html {
				margin: 0;
				font-family: 'Lato', sans-serif;
				font-size: 14px;
			}
			#map {
				width: 100%;
				height: 100%;
				z-index: 1;
			}
			#overlay {
				position: absolute; 
				top: 30px;
				right: 30px;
				background-color: white; 
				width: 300px; 
				z-index: 100;
				padding: 20px;
				border-radius: 10px;
				opacity: 0.9;
			}
			#meteo {
				position: absolute; 
				top: 160px;
				right: 30px;
				background-color: white; 
				width: 300px; 
				z-index: 100;
				padding: 20px;
				border-radius: 10px;
				opacity: 0.9;
			}
		</style>
	</head>
	<body>

		<div id="map"></div>

		<div id="overlay">
			Seleccionar fecha de visualización de los datos.<br/><br/>
			Fecha:&nbsp;&nbsp;&nbsp;<input type="text" id="datepicker" class="date">
		</div>

		<div id="meteo">
		</div>

		<script>
			const so2_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "SO2"
			})

			const no2_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "NO2"
			})

			const pm25_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "PM 2.5"
			})

			const pm10_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "PM 10"
			})

			const o3_legend = Legend(d3.scaleSequential([0, 100], d3.interpolateViridis), {
			  title: "O3"
			})

			var map = L.map('map').setView([40.4265, -3.67256], 13).on('popupopen', function () {
				d3.select("#SO2Legend")
				  .node()
				  .appendChild(so2_legend);
				d3.select("#NO2Legend")
				  .node()
				  .appendChild(no2_legend);
				d3.select("#PM25Legend")
				  .node()
				  .appendChild(pm25_legend);
				d3.select("#PM10Legend")
				  .node()
				  .appendChild(pm10_legend);
				d3.select("#O3Legend")
				  .node()
				  .appendChild(o3_legend);
			});

			// Creamos el mapa con leaflet
			var tiles = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
					'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1,
			}).addTo(map);


			//var circle=L.circle([40.423852,-3.712246], {radius: 200}).addTo(map);

			function renderStations(fecha)
			{
				// Cargamos los datos de los ficheros csv. Lo primero es cargar la estaciones de control
				d3.dsv(";", "./data/estaciones_control_aire.csv").then(function(data) {
					data.forEach(function(d) {
						var latitud = d.LATITUD;
						var longitud = d.LONGITUD;
						var estacion = d.CODIGO_CORTO;
						var nom_estacion = d.ESTACION

						// Cargarmos el fichero con los datos para el año seleccionado
						var file_name = "./data/datos" + fecha.getFullYear() + "11.csv";
						d3.dsv(";", file_name).then(function(data) {
							var filteredData = data.filter(function(row, i) {
								var myMonth = ("0" + (fecha.getMonth() + 1)).slice(-2);
								return row.MES == myMonth && row.ESTACION == estacion && (row.MAGNITUD == '1' || row.MAGNITUD == '8' || row.MAGNITUD == '9' || row.MAGNITUD == '10' || row.MAGNITUD == '14');
							});

							var indice_calidad = 0;
							var valor_so2 = 0;
							var valor_no2 = 0;
							var valor_pm25 = 0;
							var valor_pm10 = 0;
							var valor_o3 = 0;

							filteredData.forEach(function(item) {
								var magnitud = item.MAGNITUD;
								var myDay = ("0" + fecha.getDate()).slice(-2);
								var valor = item['D' + myDay];

								// Dióxido de Azufre SO2
								if (magnitud == 1) {
									valor_so2 = valor;
									if (valor <= 100)
										indice_calidad = Math.max(indice_calidad, 0);
									else if (valor <= 200)
										indice_calidad = Math.max(indice_calidad, 1);
									else if (valor <= 350)
										indice_calidad = Math.max(indice_calidad, 2);
									else if (valor <= 500)
										indice_calidad = Math.max(indice_calidad, 3);
									else
										indice_calidad = 4;
								}

								// Dióxido de Nitrógeno NO2
								if (magnitud == 8) {
									valor_no2 = valor;
									if (valor <= 40)
										indice_calidad = Math.max(indice_calidad, 0);
									else if (valor <= 100)
										indice_calidad = Math.max(indice_calidad, 1);
									else if (valor <= 200)
										indice_calidad = Math.max(indice_calidad, 2);
									else if (valor <= 400)
										indice_calidad = Math.max(indice_calidad, 3);
									else
										indice_calidad = 4;
								}

								// Partículas < 2.5 µm PM2.5
								if (magnitud == 9) {
									valor_pm25 = valor;
									if (valor <= 10)
										indice_calidad = Math.max(indice_calidad, 0);
									else if (valor <= 20)
										indice_calidad = Math.max(indice_calidad, 1);
									else if (valor <= 25)
										indice_calidad = Math.max(indice_calidad, 2);
									else if (valor <= 50)
										indice_calidad = Math.max(indice_calidad, 3);
									else
										indice_calidad = 4;
								}

								// Partículas < 10 µm PM10
								if (magnitud == 10) {
									valor_pm10 = valor;
									if (valor <= 20)
										indice_calidad = Math.max(indice_calidad, 0);
									else if (valor <= 35)
										indice_calidad = Math.max(indice_calidad, 1);
									else if (valor <= 50)
										indice_calidad = Math.max(indice_calidad, 2);
									else if (valor <= 100)
										indice_calidad = Math.max(indice_calidad, 3);
									else
										indice_calidad = 4;
								}

								// Ozono O3
								if (magnitud == 14) {
									valor_o3 = valor;
									if (valor <= 100)
										indice_calidad = Math.max(indice_calidad, 0);
									else if (valor <= 200)
										indice_calidad = Math.max(indice_calidad, 1);
									else if (valor <= 350)
										indice_calidad = Math.max(indice_calidad, 2);
									else if (valor <= 500)
										indice_calidad = Math.max(indice_calidad, 3);
									else
										indice_calidad = 4;
								}

							});

							//circle.bindPopup(new L.popup().setContent('<div id="SO2Legend"></div><div id="NO2Legend"></div><div id="PM25Legend"></div><div id="PM10Legend"></div><div id="O3Legend"></div>'));

							var colorCircle = "#6f6f6f";
							switch (indice_calidad) {
								case 0:
									colorCircle = "#50f0e6";
									break;
								case 1:
									colorCircle = "#50ccaa";
									break;
								case 2:
									colorCircle = "#f0e641";
									break;
								case 3:
									colorCircle = "#ff5050";
									break;
								case 4:
									colorCircle = "#7d2181";
									break;
							} 
							var circle = L.circle([latitud, longitud], {radius: 200, color: colorCircle, opacity: 1, fillOpacity: 0.6}).addTo(map);

							circle.bindPopup(new L.popup().setContent('<div>' + nom_estacion + '<br/>Indice de calidad: ' + indice_calidad + '<br/>SO2: ' + valor_so2 + '<br/>NO2: ' + valor_no2 + '<br/>PM2.5: ' + valor_pm25 + '<br/>PM10: ' + valor_pm10 + '<br/>O3: ' + valor_o3 + '</div>'));
						});
					});
				});

				// Cargarmos el fichero con los datos meteorológicos para el año seleccionado
				var file_name = "./data/meteo" + fecha.getFullYear().toString().substr(-2) + ".csv";
				d3.dsv(";", file_name).then(function(data) {
					var filteredData = data.filter(function(row, i) {
						var myMonth = ("0" + (fecha.getMonth() + 1)).slice(-2);
						return row.MES == myMonth && row.ESTACION == '102' && (row.MAGNITUD == '81' || row.MAGNITUD == '83' || row.MAGNITUD == '89');
					});

					filteredData.forEach(function(item) {
						var magnitud = item.MAGNITUD;
						var myDay = ("0" + fecha.getDate()).slice(-2);
						var valor = item['D' + myDay];

						if (magnitud == '81')
							$("#meteo").append("Velocidad del viento: " + valor + "<br/>");
						else if (magnitud == '83')
							$("#meteo").append("Temperatura: " + valor + "<br/>");
						else if (magnitud == '89')
							$("#meteo").append("Precipitación: " + valor + "<br/>");
					});
				});

			}						

			$(".date")
			.datepicker({
				onSelect: function(dateText, inst) {
					alert("Selected date: " + dateText + "; input's current value: " + this.value);
					$(this).change();
					renderStations(new Date(inst.selectedYear, inst.selectedMonth, inst.selectedDay));
				}
			})
			.on("change", function() {
				alert("Got change event from field");
			});

		</script>



<script>

// set the dimensions and margins of the graph
const margin = {top: 10, right: 30, bottom: 90, left: 40},
    width = 300 - margin.left - margin.right,
    height = 250 - margin.top - margin.bottom;

// append the svg object to the body of the page
const svg = d3.select("#meteo")
  .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

// Parse the Data
//d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/7_OneCatOneNum_header.csv").then( function(data) {
d3.dsv(";", "./data/meteo21.csv").then(function(data) {

var filteredData = data.filter(function(row, i) {
	return row.MES == '01' && row.ESTACION == '102' && row.MAGNITUD == '89';
});

var nets = [];
var keys = ['D01','D02','D03','D04'];
keys.forEach(function (item) {
	var valor = filteredData[0][item];
	var obj = {
		key: d,
		value: valor
	}
	nest.push(obj);
})


var x = d3.scaleBand()
  .range([ 0, width ])
  .domain(nest.map(function(d) { return d.key; }))
  .padding(0.2);
svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(x))
  .selectAll("text")
    .attr("transform", "translate(-10,0)rotate(-45)")
    .style("text-anchor", "end");

// Add Y axis
var y = d3.scaleLinear()
  .domain([0, 13000])
  .range([ height, 0]);
svg.append("g")
  .call(d3.axisLeft(y));

// Bars
svg.selectAll("mybar")
  .data(nest)
  .enter()
  .append("rect")
    .attr("x", function(d) { return x(d.key); })
    .attr("y", function(d) { return y(d.Value); })
    .attr("width", x.bandwidth())
    .attr("height", function(d) { return height - y(d.Value); })
    .attr("fill", "#69b3a2")

})

</script>




	</body>
</html>